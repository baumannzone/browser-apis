<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Demos - IO Extended Madrid</title>

  <style>
    .garden {
      position: relative;
      width: 200px;
      height: 200px;
      border: 5px solid #ddd;
      border-radius: 5px;
    }

    .ball {
      position: absolute;
      top: 90px;
      left: 90px;
      width: 20px;
      height: 20px;
      background: #35ccc1;
      border-radius: 100%;
    }
  </style>
</head>

<body>


<h1>Demos</h1>

<!--<form id="form">-->
<!--  <label for="user">User:</label>-->
<!--  <input type="text" name="id" id="user" autocomplete="username"/>-->
<!--  <label for="password">Pass:</label>-->
<!--  <input type="password" name="password" id="password" autocomplete="current-password"/>-->
<!--</form>-->

<!--<button id="button">Click me</button>-->

<!--<div id="output"></div>-->

<div class="garden">
  <div class="ball"></div>
</div>

<pre class="result"></pre>

<script>
  const output = document.getElementById('output')
  const button = document.getElementById('button')

  // Orientation Demo
  const ball = document.querySelector('.ball')
  const garden = document.querySelector('.garden')
  const result = document.querySelector('.result')

  const maxX = garden.clientWidth - ball.clientWidth
  const maxY = garden.clientHeight - ball.clientHeight

  function demoBattery() {
    navigator.getBattery()
      .then((battery) => {
        console.log('battery:')
        console.log(battery)
        battery.addEventListener('onchargingchange', onchargingchange(battery))
        battery.addEventListener("onlevelchange", onlevelchange(battery))
      })

    function onlevelchange(battery) {
      console.log('Battery status: ' + battery.level * 100 + ' %')
    }

    function onchargingchange(battery) {
      if (battery.charging) {
        console.log("Battery is charging")
      }
    }
  }

  function demoGeoLocation() {
    if ("geolocation" in navigator) {
      /* geolocalizaci√≥n disponible */
      console.log('Loading position...')
      navigator.geolocation.getCurrentPosition(position => {
        console.log('Position:')
        console.log(position.coords)

        const latitude = position.coords.latitude
        const longitude = position.coords.longitude

        output.innerHTML = '<p>Latitude is ' + latitude + '¬∞ <br>Longitude is ' + longitude + '¬∞</p>'

        const url = `https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=8e456d1b8c004a1384e71d9a6c97e94f`

        fetch(url)
          .then(response => response.json())
          .then((res) => {
            console.log('External ¬∑ Geo API:')
            console.log(res.results[0].formatted)
            console.log(res.results[0].components)
            // console.log(res.results[0].components.country)
            // console.log(res.results[0].components.state)
            // console.log(res.results[0].components.county)
            // console.log(res.results[0].components.city)
          })

      }, error => console.error(error))
    } else {
      console.log('GEO no disponible')
      /* geolocalizaci√≥n NO disponible */
    }
  }

  function demoVibration() {
    /**
     * The vibrate API is only available once the user has started interacting with your page
     * (e.g, by tapping or dragging on the screen).
     * It cannot be used before a user interaction
     * this is to prevent web pages (particularly embedded advertisements!)
     * from attempting to scare the user by making their phone vibrate.
     */

    output.innerHTML = '<p>!!!</p>'
    // if (!('vibrate' in navigator) && ('ontouchstart' in window)) {
    //   return false
    // }

    if ('vibrate' in navigator) {
      output.innerHTML = '<p>Vamos a vibrar...</p>'
      navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate
      navigator.vibrate([200, 100, 200, 100, 200, 100, 200])
      navigator.vibrate(400)
    }
  }

  function demoBluetooth() {
    console.log('Bluetooth...')

    /**
     * As a security feature, discovering Bluetooth devices with navigator.bluetooth.requestDevice
     * must be triggered by a user gesture such as a touch or a mouse click.
     * We're talking about listening to pointerup, click, and touchend events.
     */

    const options = {
      filters: [
        {services: ['heart_rate']},
        {services: [0x1802, 0x1803]},
        {services: ['c48e6067-5295-48d3-8d5c-0395f61792b1']},
        {name: 'ExampleName'},
        {namePrefix: 'Prefix'}
      ],
      optionalServices: ['battery_service']
    }
    const all = {
      acceptAllDevices: true
    }

    // navigator.bluetooth.requestDevice({filters: [{services: ['battery_service']}]})
    //     .then(device => {
    //       output.innerHTML = '<p>' + JSON.stringify(device) + '</p>'
    //     })
    //     .catch(error => {
    //       console.log(error)
    //     })

    // navigator.bluetooth.requestDevice(all)
    //     .then((device) => {
    //       console.log('Name: ' + device.name)
    //       console.log(device)
    //       output.innerHTML = '<p>' + device.name + '</p>'
    //       device.gatt.connect()
    //     })
    //     .catch((error) => {
    //       console.log("Something went wrong. " + error)
    //       output.innerHTML = '<p>' + error + '</p>'
    //     })
    // }

    const bat = {
      filters: [
        {services: ['battery_service']}
      ]
    }
    navigator.bluetooth.requestDevice(bat)
      .then((device) => {
        output.innerHTML = '<h3>' + device.name + '</h3>'
        return device.gatt.connect()
      })
      .then((server) => {
        // Getting Battery Service...
        console.log(server)
        return server.getPrimaryService('battery_service')
      })
      .then((service) => {
        // Getting Battery Level Characteristic...
        console.log(service)
        return service.getCharacteristic('battery_level')
      })
      .then((characteristic) => {
        // Reading Battery Level...
        console.log(characteristic)
        return characteristic.readValue()
      })
      .then(value => {
        console.log(value)
        console.log('Battery percentage is ' + value.getUint8(0))
      })
      .catch(error => {
        console.log(error)
        output.innerHTML = '<p>' + error + '</p>'
      })
  }

  function demoAudio() {
    console.log('Audio...')
    const ac = new AudioContext()
    const oscillator = ac.createOscillator()
    // oscillator.type = 'sawtooth'
    oscillator.connect(ac.destination)

    const time = ac.currentTime
    oscillator.frequency.value = 400
    oscillator.start(time)
    oscillator.stop(time + 0.5)

    // It sounds twice
    oscillator.onended = function () {
      console.log('Termine de sonar')
      if (this.frequency.value === 400) {
        const ac = new AudioContext()
        const oscillator = ac.createOscillator()
        const time = ac.currentTime
        oscillator.connect(ac.destination)
        oscillator.frequency.value = 500
        oscillator.start(time)
        oscillator.stop(time + 0.5)
      }
    }

    // A string which specifies the shape of waveform to play;
    // this can be one of a number of standard values, or custom to use a PeriodicWave to describe a custom waveform.
    // Different waves will produce different tones. Standard values are "sine", "square", "sawtooth", "triangle" and "custom".
    // The default is "sine".
  }

  function demoNotifications() {
    Notification.requestPermission()
      .then((permission) => {
        console.log('permission')
        console.log(permission) // may be => granted ¬∑ denied
        if (permission === 'granted') {
          const noti = new Notification('üò†üò† 3. horas. probando', {body: 'Ten√≠a el modo no molestar...ü§¶‚Äç‚ôÇÔ∏è'})
        }
      })
  }

  function demoShare() {
    if (navigator.share) {
      navigator.share({
        title: 'Baumannzone',
        text: 'Hey, look at this awesome twitter guy! üôä',
        url: 'https://twitter.com/baumannzone',
      })
    } else {
      output.innerHTML = '<p>You can\'t share!</p>'
    }
  }

  function demoCredentials() {
    const id = document.getElementById('user').value
    const password = document.getElementById('password').value

    const cred = new PasswordCredential({
      id,
      password
    })
    navigator.credentials.store(cred)
  }

  function handleOrientation(event) {
    let x = event.beta  // In degree in the range [-180,180]
    let y = event.gamma // In degree in the range [-90,90]

    result.innerHTML = "beta : " + x + "\n"
    result.innerHTML += "gamma: " + y + "\n"

    // Because we don't want to have the device upside down
    // We constrain the x value to the range [-90,90]
    if (x > 90) {
      x = 90
    }

    if (x < -90) {
      x = -90
    }

    // To make computation easier we shift the range of
    // x and y to [0,180]
    x += 90
    y += 90

    // 10 is half the size of the ball
    // It center the positioning point to the center of the ball
    ball.style.top = (maxX * x / 180 - 10) + "px"
    ball.style.left = (maxY * y / 180 - 10) + "px"
  }

  // demoBattery()
  // demoGeoLocation()
  // button.addEventListener('click', demoVibration)
  // button.addEventListener('click', demoBluetooth)
  // button.addEventListener('click', demoAudio)
  // button.addEventListener('click', demoNotifications)
  // button.addEventListener('click', demoShare)
  // button.addEventListener('click', demoCredentials)
  // button.addEventListener('click', demoOrientation)
  window.addEventListener('deviceorientation', handleOrientation)

</script>

</body>
</html>
